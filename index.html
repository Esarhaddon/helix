<!DOCTYPE html>
<html>
  <head></head>
  <body>
    <div id="root"></div>
  </body>
  <script>
    const eventTarget = new EventTarget();
    const components = {};
    const instances = {};

    function snakeCase(str) {
      return str
        .split("")
        .flatMap((char, i) =>
          /[A-Z]/.test(char) && i !== 0 ? ["-", char] : char
        )
        .join("")
        .toLowerCase();
    }

    function getUnreplacedNames(template) {
      return [
        ...new Set(
          [...template.matchAll(/<\/([A-Z].*?)>/g)].map(
            ([_, componentName]) => componentName
          )
        ),
      ];
    }

    const counts = {};
    const unPrefixed = Symbol();

    function getId(prefix) {
      const key = prefix || unPrefixed;
      counts[key] ||= 0;

      return (prefix ? prefix + "_" : "") + ++counts[key];
    }

    let newSignals = [];
    let currentInstanceSignals = [];

    // Rules of hooks apply
    function signal(initialValue) {
      let signal = currentInstanceSignals.shift();

      if (!signal) {
        const id = getId("signal");

        signal = {
          id,
          proxy: new Proxy(
            { value: initialValue },
            {
              get(target, prop) {
                if (prop === "id") {
                  return id;
                }
                return target[prop];
              },

              set(target, prop, value) {
                target[prop] = value;

                if (prop === "value") {
                  eventTarget.dispatchEvent(
                    new CustomEvent("signalUpdate", {
                      detail: {
                        id,
                        value,
                      },
                    })
                  );
                }
              },
            }
          ),
        };

        newSignals.push(signal);
      }

      return signal.proxy;
    }

    function render(component, destination) {
      let html = component();
      const componentNames = getUnreplacedNames(html);

      componentNames.forEach((componentName) => {
        if (!components[componentName]) {
          const Component = class extends HTMLElement {
            signals = [];

            connectedCallback() {
              const key = this.getAttribute("key") || getId("fwc");
              this.setAttribute("key", key);

              console.log(`[${componentName}.${key}] connected, rendering...`);

              currentInstanceSignals = [...this.signals];
              render(window[componentName], this);
              this.signals = [...newSignals];
              newSignals = [];

              eventTarget.addEventListener(
                "signalUpdate",
                this.handleSignalUpdate
              );
            }

            disconnectedCallback() {
              eventTarget.removeEventListener(
                "signalUpdate",
                this.handleSignalUpdate
              );
            }

            // Arrow function for event listener
            handleSignalUpdate = ({ detail: { id } }) => {
              if (this.signals.some((signal) => signal.id === id)) {
                currentInstanceSignals = [...this.signals];
                render(window[componentName], this);
              }
            };
          };

          customElements.define(snakeCase(componentName), Component);
          components[componentName] = {
            component: Component,
            defined: true,
          };
        }

        html = html.replaceAll(componentName, snakeCase(componentName));
      });

      destination.innerHTML = html;
    }

    function MyButton() {
      const count = signal(0);
      const globalFnName = "setCount_" + count.id;
      window[globalFnName] = (value) => (count.value = value);

      return `
        <div>${count.value}</div>
        <button onclick="window.${globalFnName}(${count.value + 1})">
          press me
        </button>
      `;
    }

    function HelloWorld() {
      return `
        <div>hello world</div>
        <MyButton></MyButton>
      `;
    }

    function App() {
      return `
        <div>greetings:</div>
        <!-- <HelloWorld></HelloWorld> -->
        <HelloWorld></HelloWorld>
        <HelloWorld></HelloWorld>
      `;
    }

    render(App, document.getElementById("root"));
  </script>
</html>
