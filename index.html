<!DOCTYPE html>
<html>
  <head> </head>
  <body>
    <div id="root"></div>
  </body>
  <script>
    const eventTarget = new EventTarget();
    const components = {};
    const instances = {};
    const newSignals = [];
    const currentInstanceSignals = [];

    function snakeCase(str) {
      return str
        .split("")
        .flatMap((char, i) =>
          /[A-Z]/.test(char) && i !== 0 ? ["-", char] : char
        )
        .join("")
        .toLowerCase();
    }

    function getUnreplacedNames(template) {
      return [
        ...new Set(
          [...template.matchAll(/<\/([A-Z].*?)>/g)].map(
            ([_, componentName]) => componentName
          )
        ),
      ];
    }

    const counts = {};
    const unPrefixed = Symbol();

    function getId(prefix) {
      const key = prefix || unPrefixed;
      counts[key] ||= 0;

      return (prefix ? prefix + "_" : "") + ++counts[key];
    }

    function signal(initialValue) {
      let signal = currentInstanceSignals.pop();

      if (!signal) {
        signal = {
          id: getId(),
          proxy: new Proxy(
            { initialValue },
            {
              set(target, prop, value) {
                if (prop === "value") {
                  eventTarget.dispatchEvent(new CustomEvent(id, { value }));
                }

                target[prop] = value;
              },
            }
          ),
        };

        newSignals.push(signal);
      }

      return signal.proxy;
    }

    function render(component, destination) {
      let html = component();
      const componentNames = getUnreplacedNames(html);

      componentNames.forEach((componentName) => {
        if (!components[componentName]) {
          const Component = class extends HTMLElement {
            connectedCallback() {
              const key = this.getAttribute("key") || getId("fwc");
              this.setAttribute("key", key);

              console.log(`[${componentName}.${key}] connected, rendering...`);
              render(window[componentName], this);
            }
          };

          customElements.define(snakeCase(componentName), Component);
          components[componentName] = {
            component: Component,
            defined: true,
          };
        }

        html = html.replaceAll(componentName, snakeCase(componentName));
      });

      destination.innerHTML = html;
    }

    function MyButton() {
      return `<button>press me</button>`;
    }

    function HelloWorld() {
      return `
        <div>hello world</div>
        <MyButton></MyButton>
      `;
    }

    function App() {
      return `
        <div>greetings:</div>
        <HelloWorld key="key-override"></HelloWorld>
        <HelloWorld></HelloWorld>
      `;
    }

    render(App, document.getElementById("root"));
  </script>
</html>
